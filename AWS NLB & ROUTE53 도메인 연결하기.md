[ID: 8]
[Tags: CLOUD PROJECTS]
[Title: AWS NLB & ROUTE53 도메인 연결하기]
[WriteTime: 2023/07/20]
[ImageNames: ]

## 개요

이 글은 구매와 등록이 된 도메인이 이미 있고, NLB와 서비스가 연결된 상태여서 NLB의 EIP, SIP나 DNSname으로 서비스에 HTTP/HTTPS 접근이 가능한 상태일 때, 

호스트로 NLB의 DNSname 대신 구매한 도메인으로 서비스에 접근할 수 있게하는 방법과 과정을 소개하는 글이다.

+ 마지막의 정리 섹션은 HAPROXY를 클러스터 내부 리버스프록시/로드밸런서로 사용한다는 가정하에 클라이언트 요청의 흐름을 정리해보았다. 그러나 클러스터 내부 로드밸런서/리버스프록시로 HAPROXY를 사용하지 않고, ingress controller나, ALB를 사용하더라도 이 글의 내용은 적용이 가능하다.

+ ALB도 생성 시 DNS 이름을 제공하기 때문에 이 글의 내용을  적용할 수 있다.

---

## 호스팅영역 생성 및 설정

AWS Console의 라우트53 서비스에 접속해 사이드바의 호스팅영역 탭을 클릭한다.

호스팅영역 생성을 눌러준다.

- 도메인 이름은 자신이 구매/등록한 메인도메인을 적는다.

- 유형은 퍼블릭 호스팅영역으로 설정한다. 프라이빗으로 설정하면 외부 클라이언트는 접근하지 못하고, 로드밸런서가 기능하는 VPC 내부에서만 사용되는 도메인이 된다.

그럼 NS유형과 SOA유형의 레코드가 생성된 걸 확인할 수 있다.

---

## 도메인과 호스트영역 연결

NS는 NameServer의 약자로 도메인이 호스팅영역을 식별하도록 해준다. NS 레코드의 값/트래픽 라우팅 대상으로 지정되어있는 

    ns-

로 시작하는 4개의 네임서버를 복사한다.

방금 복사한 네임서버 값들을 자신이 도메인을 생성한 사이트로 들어가서 도메인의 네임서버를 붙여넣어준다. 나는 도메인 생성도 route53을 통해서 했기 때문에 그대로 AWS Console상에서 진행하였다.

사이드바에 도메인 - 등록된 도메인 탭에 들어가서, 생성한 도메인을 누르고 세부정보 섹션의 작업 - 이름서버 편집을 누른다. 

4개의 이름서버 값을 아까 복사한 값으로 변경해주고, 변경 사항을 저장한다.

사이드바의 도메인-요청 탭에 들어가면 진행상태를 확인할 수 있다. 이제 도메인과 호스팅영역은 연결이 완료되었다.

---

## 호스팅영역 레코드 생성 및 설정

이제 EC2 서비스로 접속해서, 사이드바의 로드밸런싱-로드밸런서 탭으로 들어간다.

연결할 NLB를 클릭하면 세부정보로 DNS 이름을 확인할 수 있다. DNS 이름을 복사한다.

다시 route53 서비스로 돌아와 아까 생성한 호스팅 영역을 선택한다.

레코드 생성 버튼을 누르고 라우팅정책은 단순라우팅을 선택하고 다음 단계로 넘어간다.

단순 레코드 정의를 선택하면 모달창으로 설정창이 생긴다. 래코드 이름 섹션에서는 도메인 앞에 서브도메인으로 사용될 값을 적는다. 따로 적지 않으면 서브도메인 없이 진행된다.

> 브라우저는 서브도메인이 없으면 알아서 www를 서브도메인으로 사용한다. 브라우저에서 google.com만 입력해도 알아서 www.google.com으로 요쳥이 변환되는 걸 확인할 수 있다.

> 그래서 클라이언트의 접속이 정상적으로 브라우저에서 이루어지게하려면 서브도메인을 www로 설정하는 것이 좋다.

그래야 클라이언트는 example.com으로 입력하든, www.example.com으로 입력하든 서비스에 접근할 수 있게 된다.

서브도메인을 입력하지 않으면 클라이언트는 정상적으로 도메인을 브라우저에 입력했지만, 브라우저는 알아서 www.을 접두어로 붙여서 www.example.com에 대한 라우팅 정보를 찾게되고, 이건 호스팅영역 레코드에 정의되어있지 않기 때문에 NLB로의 정상적인 라우팅이 불가능해진다.

레코드 유형은 A 또는 CNAME으로 설정할 수 있다. 유형 A는 도메인을 IP로 라우팅해주는 유형이고, CNAME은 도메인을 다른 도메인으로 라우팅해주는 유형이다.

NLB는 SIP, EIP를 지원하고, DNS 이름도 생성되기 때문에 둘 줄 아무거나 선택해도 된다. 만약 NLB가 아닌 ALB라면 ALB는 DNSname은 지원하지만 SIP나 EIP를 지원하지 않기 때문에 CNAME으로 설정해야 정상적으로 ALB와 도메인이 연결될 수 있다.

### A로 설정 시

엔드포인트는 Network LoadBalancer에 대한 별칭으로 설정한다.

로드밸런서가 트래픽을 전달하는 VPC나 인스턴스의 리전을 선택해주고, 해당하는 로드밸런서를 선택한다.

### CNAME으로 설정 시 

레코드 유형에 따른 ip 주소 또는 다른 값으로 라우팅 대상을 설정해주고,

내용으로는 NLB의 DNS 이름을 넣어준다.

---

이제 단순 레코드 정의를 누르고, 레코드 선택을 누른다. 레코드가 생성되는데도 약간의 시간이 소요된다.

이제 모든 작업은 완료되었고, 구매/등록한 도메인을 브라우저에서 입력하면 정상적으로 서비스에 접근할 수 있게 된다.

---

## 정리

```
브라우저에서 도메인 입력 > NLB의 DNSname 또는 IP로 라우팅 > NLB가 트래픽을 받아서 HAPROXY 서비스의 NodePort로 라우팅 > HAPROXY 서비스가 HAPROXY Pod로 라우팅 > HAPROXY Pod에서 요청 복호화 후 알맞은 백엔드 서비스로 서비스 디스커버리를 통해 로드밸런싱 > 백엔드 서비스가 백엔드 Pod로 라우팅
```

웹 어플리케이션의 배포는 참 수많은 라우팅의 연속이다.