[ID: 13]
[Tags: PROJECTS]
[Title: 내가 만든 테크 블로그에 리팩토링이 필요한 이유]
[WriteTime: 2023/08/16]
[ImageNames: ]

## 개요

블로그 프로젝트를 마치고 AWS t2.micro 프리티어 인스턴스에 배포를 완료했다. 이후 커플 채팅 서비스 프로젝트를 개발완료하고, 커플 채팅 서비스의 배포를 위해 Kubernetes와 Terraform, HAProxy, Kubeadm 등의 툴을 추가로 공부했다.

해당 툴들을 처음 배포/운영에 적용해보는 것이기에 긴 시간 동안의 운영과 그에 따른 여러 오류의 해결 과정까지 경험해보는 것이 필요하다고 생각했다.

커플 채팅 서비스는 비용 문제로 지속적인 운영이 불가능하지만, 블로그는 앞으로도 꾸준히 운영될 서비스이다. 때문에 커플 채팅 서비스의 배포는 조금 미루기로 했다. 블로그 프로젝트를 리팩토링하며 재배포해서 먼저 K8S, HAProxy 등에 대한 실질적인 이해와 경험을 더 쌓고, 충분히 경험과 이해가 쌓인 후에 커플 채팅 서비스를 잠깐 배포/운영해보는 방식으로 진행키로 했다.

앞으로의 블로그 관련 포스트는 블로그 리팩토링 및 쿠버네티스 상 배포 및 운영에 관한 내용들을 다루게 될 것이고, 이 글은 이전 블로그 서비스의 문제점들에 대해 정리하는 글이다.

---

## 블로그 프로젝트 배포 및 운영 현상황

겉보기에는 SSL/TLS 인증과 도메인까지 연결해서, 겉보기엔 말끔한 블로그 사이트가 운영중이다.

내부적으로는 주먹구구식으로 구현되있는 것들이 많았다.

### 문제 1: SSL/TLS종료, 로드밸런서, 도메인, 리버스프록시에 대한 이해 부족

1. SSL/TLS종료

SSL/TLS 인증 및 종료는 실제 SSL/TLS 인증서를 발급받아 종료를 구현하는 방법 대신, AWS의 ACM(AWS Certificate Manager)을 이용해 간편하게 인증을 받았다. SSL/TLS가 뭔지, 왜 필요한지, SSL/TLS종료가 뭔지 모르고 그냥 HTTP로 접속하면 안전하지 않다고 하니까 그냥 블로그를 보고 따라했다.

2. 로드밸런서

HTTP -> HTTPS 리다이렉트는 AWS ALB를 통해 리다이렉팅했다. ALB가 뭔지, 리다이렉팅이 왜 필요한지도 모르고 그냥 했다.

3. 도메인

도메인 연결도 도메인 구매, 도메인 등록, 호스팅 영역 생성, 네임서버 등록 등 아무것도 이해하지 못했지만 그냥 따라서 ROUTE53을 이용해 구현했다.

지금은 따로 AWS와 풀스택 서비스의 네트워킹에 대해 이해가 잡혀서 세 기능 모두 이해하고 사용할 수 있게 되었다. 리팩토링하며 불필요한 부분들을 제거하고, 필요한 부분들을 추가해서 다시 배포할 필요성이 있었다.

4. 리버스프록시

리버스프록시로 nginx를 사용했는데, 리버스프록시의 역할을 자세히 알지 못하고, 그냥 설정파일을 이렇게 세팅하면 백엔드와 프론트엔드가 통신할 수 있다고해서 따라했다. 

따라하며 생기는 크고 작은 오류들을 해결하고 알아보면서 배운 것도 많지만, 지금 생각해보면 그냥 **프로그램이 돌아가게하는 것**에만 집중했던 것 같다.

### 문제 2: BE의 디자인패턴

백엔드는 하나의 거대한(거대하지는 않지만) main.go 파일에서 모든 것을 해결했다. 라우터부터 비즈니스 로직, DB와의 쿼리, 에러처리 등

그러다보니 운영 중 생기는 보수 과정에서 코드를 읽기가 너무 힘들었다.

아키텍처적인 문제 뿐만 아니라 코드의 형식도 일관성이 없었다. 리팩토링하며 변수, 함수 이름에 일정한 컨벤션을 적용하고, 디렉토리 구조도 MVC패턴으로 변경함으로써 유지/보수가 간편하도록 만들 필요성이 있었다.

### 문제 3: 코드 퀄리티

크지 않은 프로젝트이지만 코드 중복도 피하며 재사용성 높은 코드들로 재작성해서 리소스 사용량을 줄일 필요성도 있었다. 

또 블로그를 운영하면서 여러 코드적인 버그들을 마주치게 되었고, 수정할 필요성이 있었다.

### 문제 4: 배포 방식

1. 버전 업데이트

배포 이후 코드 수정을 하기 위해서는 원격으로 서버에 접속해서 vim 에디터로 코드를 하나하나 수정해주어야했는데, 그 과정이 너무 불편했다. 

앞으로도 운영될 것이기 때문에 로컬에서 코드 수정 후 이미지 빌드 후 쿠버네티스 오브젝트를 통해 업데이트를 상대적으로 간편하게 할 필요성이 있었다.

2. 리소스 부족

배포에 대한 이해가 지금보다도 훨씬 부족했던지라, t2.micro 인스턴스 하나에 모든 서비스를 다 배포했다. t2.micro는 CPU 1코어와 1GiB RAM이라는 정말 턱없이 부족한 리소스를 가지고있는데, 이 안에 모든 서비스를 배포하다보니 문제가 많았다.

1번에서 언급한 것처럼 코드를 수정하려면 원격으로 서버에 접속해서 수정해야했는데, 특히 프론트엔드 코드를 수정하고 빌드를 다시 하면, 빌드하는 과정에서 리소스가 부족해 서버가 강제 종료되는 상황이 계속 발생했다.

프론트엔드와 백엔드, DB를 여러 인스턴스로 분리하거나 인스턴스를 수직적으로 확장할 필요성이 있었다.

### 문제 5: 반응형 웹 어플리케이션

기존 운영은 철저히 PC만을 위한 블로그였다. 모바일에서 접근이야 물론 가능하지만, 반응형 웹으로 개발하지 않았기 때문에, 난리가 난 블로그의 모습을 볼 수 있었다.

블로그는 PC만큼이나 모바일 환경에서도 많이 보여지기 때문에, 반응형으로 프론트엔드 코드를 리팩토링할 필요성이 있었다.

---

## 정리

이런 문제점들이 있었고, 학습한 쿠버네티스와 테라폼 등을 실제 배포/운영에 적용해보기 위해 블로그 프로젝트를 리팩토링하기로 했다.